<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.boss.xtrain.exam.dao.mapper.ExamRecordMapper" >
  <resultMap id="BaseResultMap" type="com.boss.xtrain.exam.pojo.entity.ExamRecord" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jul 07 17:49:29 CST 2020.
    -->
    <result column="id" property="id" jdbcType="BIGINT" />
    <result column="t_pr_id" property="publishId" jdbcType="BIGINT" />
    <result column="t_p_id" property="examPeople" jdbcType="BIGINT" />
    <result column="plan_start_time" property="planStartTime" jdbcType="TIMESTAMP" />
    <result column="plan_end_time" property="planEndTime" jdbcType="TIMESTAMP" />
    <result column="actual_start_time" property="actualStartTime" jdbcType="TIMESTAMP" />
    <result column="actual_end_time" property="actualEndTime" jdbcType="TIMESTAMP" />
    <result column="objective_subject_score" property="objectiveSubjectScore" jdbcType="DECIMAL" />
    <result column="t_u_id" property="markUserId" jdbcType="BIGINT" />
    <result column="subjective_subject_score" property="subjectiveSubjectScore" jdbcType="DECIMAL" />
    <result column="marking_assign_time" property="markingAssignTime" jdbcType="TIMESTAMP" />
    <result column="score" property="score" jdbcType="DECIMAL" />
    <result column="system_evaluate" property="systemEvaluate" jdbcType="VARCHAR" />
    <result column="status" property="status" jdbcType="TINYINT" />
    <result column="company_id" property="companyId" jdbcType="BIGINT" />
    <result column="org_id" property="organizationId" jdbcType="BIGINT" />
    <result column="created_by" property="createdBy" jdbcType="BIGINT" />
    <result column="created_time" property="createdTime" jdbcType="TIMESTAMP" />
    <result column="updated_by" property="updatedBy" jdbcType="BIGINT" />
    <result column="updated_time" property="updatedTime" jdbcType="TIMESTAMP" />
    <result column="version" property="version" jdbcType="BIGINT" />
  </resultMap>


  <select id="queryListDataByCondition"  resultType="com.boss.xtrain.exam.pojo.entity.ExamRecordListEntity" parameterType="com.boss.xtrain.exam.pojo.entity.ExamRecordListEntity">
    <choose>
      <when test="title">
        <bind name="title" value="'%' + _parameter.title + '%'"/>
      </when>
      <otherwise>
        <bind name="title" value="'%%'"/>
      </otherwise>
    </choose>
    <choose>
      <when test="examSession">
        <bind name="ptnExamSession" value="'%' + _parameter.examSession + '%'"/>
      </when>
      <otherwise>
        <bind name="ptnExamSession" value="'%%'"/>
      </otherwise>
    </choose>
    SELECT
    r.id id,
    p.t_p_id paperId,
    p.title title,
    p.publisher publisher,
    peo.name name,
    peo.id examPeople,
    peo.mobile mobile,
    p.exam_session examSession,
    r.actual_start_time actualStartTime,
    r.actual_end_time actualEndTime,
    r.plan_end_time planEndTime,
    r.subjective_subject_score subjectiveSubjectScore,
    r.objective_subject_score objectiveSubjectScore,
    r.score score,
    r.status status ,
    r.org_id organization_id,
    r.version version,
    r.company_id companyId,
    r.created_time createdTime,
    r.created_by createdBy,
    r.created_time updatedTime,
    r.created_by updeatedBy
    FROM t_exam_record r
    LEFT JOIN t_exam_publish_record p
    ON p.id = r.t_pr_id
    LEFT JOIN t_exam_people peo
    ON r.t_p_id = peo.id
    <where>
      r.status != 0
      <if test="title != null and title != '' ">
        AND p.title LIKE #{title}
      </if>
      <if test="publisher != null and publisher != ''">
        AND p.publisher = #{publisher}
      </if>
      <if test="planStartTime != null">
        AND r.plan_start_time &gt;= #{ planStartTime }
      </if>
      <if test="planEndTime != null">
        AND r.plan_end_time &lt;= #{ planEndTime }
      </if>
      <if test="examSession != null and examSession != ''">
        AND p.exam_session LIKE #{ ptnExamSession }
      </if>
      <if test="companyId != null">
        AND p.company_id = #{companyId}
      </if>
    </where>
    ORDER BY r.`score` DESC, r.objective_subject_score DESC
  </select>

  <select id="queryReportDetail" parameterType="java.lang.Long"
          resultType="com.boss.xtrain.exam.pojo.dto.ReportDataItemDTO">
        SELECT
            peo.name peopleName,
            peo.sex sex,
            p.title title,
            r.objective_subject_score objectiveMark,
            r.subjective_subject_score subjectiveMark,
            r.score score,
           	@rownum:=@rownum+1 as rank,
            r.actual_start_time actualStartTime,
            r.actual_end_time actualEndTime
        FROM
            t_exam_record r
            LEFT JOIN t_exam_publish_record p ON p.id = r.t_pr_id
            LEFT JOIN t_exam_people peo ON r.t_p_id = peo.id,
            (select @rownum:=0) r
        WHERE r.t_pr_id = #{publishId} AND r.status != 0
        ORDER BY r.score DESC
   </select>

  <update id="updateStatus" parameterType="com.boss.xtrain.exam.pojo.entity.ExamRecord">
        UPDATE t_exam_record
        SET status       = 1,
            company_id   = #{examRecord.companyId},
            created_by   = #{examRecord.createdBy},
            created_time = #{examRecord.createdTime},
            updated_by   = #{examRecord.updatedBy},
            updated_time = #{examRecord.updatedTime},
            version      = #{examRecord.version}
        WHERE status = 0
          AND id = #{examRecord.examRecordId}
    </update>

  <select id="queryEvaluateByCondition" parameterType="com.boss.xtrain.exam.pojo.dto.query.MarkingQuery"
          resultType="com.boss.xtrain.exam.pojo.dto.MarkingDataListDto">
    <choose>
      <when test="examSession">
        <bind name="ptnExamSession" value="'%' + _parameter.examSession + '%'"/>
      </when>
      <otherwise>
        <bind name="ptnExamSession" value="'%%'"/>
      </otherwise>
    </choose>
    SELECT
    r.id examRecordId,
    p.t_p_id paperId,
    p.title title,
    p.exam_session examSession,
    peo.name name,
    peo.mobile mobile,
    p.created_time publishTime,
    r.actual_end_time actualEndTime,
    p.marking_stop_time markingStopTime,
    r.objective_subject_score objectiveSubjectScore,
    r.subjective_subject_score subjectiveSubjectScore,
    r.system_evaluate systemEvaluate,
    r.status status,
    r.version version
    FROM t_exam_record r
    LEFT JOIN t_exam_publish_record p
    ON p.id = r.t_pr_id
    LEFT JOIN t_exam_people peo
    ON r.t_p_id = peo.id
    <where>
      r.status != 0
      <if test="markPeople != null and markPeople != ''">
        AND r.t_u_id = #{ markPeople }
      </if>
      <if test="status != null and status != ''">
        AND r.status = #{ status }
      </if>
      <if test="leftHandInTime != null">
        AND r.actual_end_time &gt;= #{ leftHandInTime }
      </if>
      <if test="examSession != null and examSession != ''">
        AND p.exam_session LIKE #{ ptnExamSession }
      </if>
      <if test="rightHandInTime != null">
        AND r.actual_end_time &lt;= #{ rightHandInTime }
      </if>
    </where>
  </select>

</mapper>