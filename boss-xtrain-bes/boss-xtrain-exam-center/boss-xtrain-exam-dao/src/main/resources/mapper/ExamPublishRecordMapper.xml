<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.boss.xtrain.exam.dao.mapper.ExamPublishRecordMapper" >
  <resultMap id="BaseResultMap" type="com.boss.xtrain.exam.pojo.entity.ExamPublishRecord" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jul 07 17:49:29 CST 2020.
    -->
    <result column="id" property="id" jdbcType="BIGINT" />
    <result column="t_p_id" property="paperId" jdbcType="BIGINT" />
    <result column="title" property="title" jdbcType="VARCHAR" />
    <result column="publisher" property="publisher" jdbcType="BIGINT" />
    <result column="start_time" property="startTime" jdbcType="TIMESTAMP" />
    <result column="end_time" property="endTime" jdbcType="TIMESTAMP" />
    <result column="plan_people_num" property="planPeopleNum" jdbcType="INTEGER" />
    <result column="limit_time" property="limitTime" jdbcType="BIGINT" />
    <result column="description" property="description" jdbcType="VARCHAR" />
    <result column="marking_mode" property="markingMode" jdbcType="TINYINT" />
    <result column="marking_stop_time" property="markingStopTime" jdbcType="TIMESTAMP" />
    <result column="qrcode_url" property="qrcodeUrl" jdbcType="VARCHAR" />
    <result column="status" property="status" jdbcType="TINYINT"/>
    <result column="company_id" property="companyId" jdbcType="BIGINT" />
    <result column="org_id" property="organizationId" jdbcType="BIGINT" />
    <result column="created_by" property="createdBy" jdbcType="BIGINT" />
    <result column="created_time" property="createdTime" jdbcType="TIMESTAMP" />
    <result column="updated_by" property="updatedBy" jdbcType="BIGINT" />
    <result column="updated_time" property="updatedTime" jdbcType="TIMESTAMP" />
    <result column="version" property="version" jdbcType="BIGINT" />
    <result column="exam_session" property="examSession" jdbcType="VARCHAR"/>
    <result column="field1" property="field1" jdbcType="VARCHAR" />
    <result column="field2" property="field2" jdbcType="VARCHAR" />
  </resultMap>

  <select id="queryListByCondition" resultMap="BaseResultMap" parameterType="com.boss.xtrain.exam.pojo.dto.query.ExamPublishRecordQuery">
    <choose>
      <when test="title">
        <bind name="title" value="'%' + _parameter.title + '%'"/>
      </when>
      <otherwise>
        <bind name="title" value="'%%'"/>
      </otherwise>
    </choose>
    SELECT * FROM t_exam_publish_record
    <where>
      <if test="title != null and title != '' ">
        AND title LIKE #{title}
      </if>
      <if test="publisher != null">
        AND publisher = #{publisher}
      </if>
      <if test="leftPublishTime != null">
        AND created_time &gt;= #{leftPublishTime}
      </if>
      <if test="rightPublishTime != null">
        AND created_time &lt;= #{rightPublishTime}
      </if>
      <if test="startTime != null">
        AND start_time &gt;= #{startTime}
      </if>
      <if test="endTime != null">
        AND end_time &lt;= #{endTime}
      </if>
      <if test="companyId != null">
        AND company_id = #{companyId}
      </if>
    </where>
  </select>

  <select id="getVersionById" parameterType="long" resultType="long">
    select t.version from t_exam_publish_record t where t.id = #{id}
  </select>


  <update id="updateStatus" parameterType="list">
    update t_exam_publish_record r
    set r.status = 1, r.version = r.version+1, r.created_by = rc.rc
    where r.status = 0 and r.version = r.version and r.id in
    <foreach collection="records" item="rc" index="index" open="(" close=")" separator=",">
      #{rc.id}
    </foreach>
  </update>

  <delete id="deleteBatch" parameterType="list">
    delete from t_exam_publish_record
    where id in
    <foreach collection="ids" item="id" open="(" close=")" separator=",">
      #{id}
    </foreach>
  </delete>

  <select id="queryReportListByCondition" parameterType="com.boss.xtrain.exam.pojo.dto.query.ExamReportQuery"
          resultType="com.boss.xtrain.exam.pojo.dto.ReportDataListDTO">
    <choose>
      <when test="title">
        <bind name="ptnTitle" value="'%' + _parameter.title + '%'"/>
      </when>
      <otherwise>
        <bind name="ptnTitle" value="'%%'"/>
      </otherwise>
    </choose>
    SELECT
    p.id publishRecordId,
    p.title title,
    p.end_time endTime,
    p.plan_people_num planPeopleNum,
    COUNT(r.id) actualPeopleNum
    FROM t_exam_publish_record p
    LEFT JOIN t_exam_record r
    ON r.t_pr_id = p.id
    <where>
      p.status = 1
      <if test="title != null and title != '' ">
        AND p.title LIKE #{ptnTitle}
      </if>
      <if test="publisher != null and publisher != ''">
        AND p.publisher = #{ publisher }
      </if>
      <if test="actualStartTime != null">
        AND p.start_time &gt;= #{ actualStartTime }
      </if>
      <if test="actualEndTime != null">
        AND p.end_time &lt;= #{ actualEndTime }
      </if>
      <if test="companyId != null">
        AND p.company_id = #{ companyId }
      </if>
    </where>
    GROUP BY p.id
  </select>

</mapper>