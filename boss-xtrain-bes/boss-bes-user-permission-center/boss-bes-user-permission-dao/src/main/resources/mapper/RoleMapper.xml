<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.boss.xtrain.permission.mapper.RoleMapper" >
  <resultMap id="RoleMap" type="com.boss.xtrain.permission.pojo.entity.Role" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jul 08 10:19:20 CST 2020.
    -->
    <result column="id" property="id" jdbcType="BIGINT" />
    <result column="t_c_id" property="tCId" jdbcType="BIGINT" />
    <result column="t_o_id" property="tOId" jdbcType="BIGINT" />
    <result column="name" property="name" jdbcType="VARCHAR" />
    <result column="code" property="code" jdbcType="VARCHAR" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
    <result column="status" property="status" jdbcType="TINYINT" />
    <result column="created_by" property="createdBy" jdbcType="BIGINT" />
    <result column="created_time" property="createdTime" jdbcType="TIMESTAMP" />
    <result column="updated_by" property="updatedBy" jdbcType="BIGINT" />
    <result column="updated_time" property="updatedTime" jdbcType="TIMESTAMP" />
    <result column="version" property="version" jdbcType="BIGINT" />
  </resultMap>
  <resultMap id="ResourceMap" type="com.boss.xtrain.permission.pojo.entity.Resource">
    <id column="id" property="id"/>
    <result column="status" property="status" />
    <result column="created_by" property="createdBy" />
    <result column="created_time" property="createdTime" />
    <result column="updated_by" property="updatedBy" />
    <result column="updated_time" property="updatedTime" />
    <result column="version" property="version" />
    <result column="code" property="code" />
    <result column="name" property="name" />
    <result column="order_index" property="orderIndex" />
    <result column="parent_id" property="parentId" />
    <result column="url" property="url" />
    <result column="open_img" property="openImg" />
    <result column="close_img" property="closeImg" />
    <result column="resource_type" property="resourceType" />
    <result column="leaf" property="leaf" />
    <result column="remark" property="remark" />
  </resultMap>

  <resultMap id="UserMap" type="com.boss.xtrain.permission.pojo.entity.User">
    <id column="id" property="id"/>
    <result column="status" property="status" />
    <result column="created_by" property="createdBy" />
    <result column="created_time" property="createdTime" />
    <result column="updated_by" property="updatedBy" />
    <result column="updated_time" property="updatedTime" />
    <result column="version" property="version" />
    <result column="t_c_id" property="companyId"/>
    <result column="t_d_id" property="departmentId" />
    <result column="code" property="code" />
    <result column="password" property="password" />
    <result column="name" property="name" />
    <result column="profile_picture" property="profilePicture" />
    <result column="password" property="password" />
    <result column="sex" property="sex" />
    <result column="birthday" property="birthday" />
    <result column="tel" property="tel" />
    <result column="email" property="email" />
    <result column="other" property="other" />
    <result column="remark" property="remark" />
  </resultMap>

  <sql id="RoleColumns">
        tr.id ,
        tr.status,
        tr.created_by,
        tr.created_time,
        tr.updated_time,
        tr.updated_by,
        tr.version,
        tr.name,
        tr.code,
        tr.remark,
        tr.company_id,
        tr.org_id,
        tc.name AS companyName,
        to_.name as orgName
    </sql>

  <!--通过RoleId去role_resource表查询相连的resourceId-->
  <select id="getResourcesByRoleId" parameterType="java.lang.Long" resultMap="ResourceMap">
        select  a.id,a.name  from t_resource a left join t_role_resource b on a.id = b.t_rs_id  where b.t_r_id = #{id}
    </select>

  <select id="getUsers" parameterType="com.boss.xtrain.permission.pojo.query.UserQueryDTO" resultMap="UserMap">
    SELECT  tu.id,tu.name,tu.code,tu.company_id as companyId, tc.name as companyName
    FROM t_user tu,t_company tc
    <where>
      tu.t_c_id = tc.id
      <if test="companyId != null and companyId != ''">
        AND tu.company_id = #{companyId}
      </if>
      <if test="name != null and name != ''">
        AND tu.name LIKE "%"#{name}"%"
      </if>
      <if test="code != null and code != ''">
        AND tu.code LIKE "%"#{code}"%"
      </if>
    </where>
  </select>
  <select id="getResources" resultType="com.boss.xtrain.permission.pojo.query.TreeNode">
        SELECT id,name,order_index,parent_id as parentId from t_resource order by order_index
    </select>
  <insert id="allocateUser" parameterType="com.boss.xtrain.permission.pojo.dto.UserRoleDTO">
        insert into t_user_role (t_r_id,t_u_id) VALUES (#{roleId},#{userId})
    </insert>
  <delete id="deleteUserRole">
    DELETE FROM t_user_role
    WHERE t_r_id IN
    <foreach collection="ids" item="item" index="index" open="(" close=")" separator=",">
      #{item}
    </foreach>
  </delete>

  <insert id="allocateResource" parameterType="com.boss.xtrain.permission.pojo.dto.RoleResourceDTO">
        insert into t_role_resource (t_r_id,t_rs_id) VALUES (#{roleId},#{resourceId})
    </insert>
  <delete id="deleteRoleResource">
    DELETE FROM t_role_resource
    WHERE t_r_id IN
    <foreach collection="ids" item="item" index="index" open="(" close=")" separator=",">
      #{item}
    </foreach>
  </delete>

  <select id="getAllRoleId" resultType="java.lang.String">
        select id from t_role
    </select>

  <select id="getStatusById" parameterType="java.lang.Long" resultMap="RoleMap">
        select status from t_role where id=#{id}
    </select>
  <select id="getResourceIdsByRoleId" parameterType="java.lang.Long" resultType="java.lang.Long">
        select  a.id  from t_resource a left join role_resource b on a.id = b.resource_id  where b.role_id = #{id}
    </select>
  <select id="queryName" parameterType="com.boss.xtrain.permission.pojo.dto.RoleDTO" resultType="com.boss.xtrain.permission.pojo.dto.RoleDTO">
        select * from t_role where name=#{name}
    </select>

  <select id="getUserIdsByRoleId" parameterType="java.lang.Long" resultType="java.lang.Long">
        select distinct a.id  from t_user a left join t_user_role b on a.id = b.t_u_id  where b.t_r_id = #{id}
    </select>

</mapper>